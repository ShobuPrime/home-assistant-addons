name: Builder

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  init:
    runs-on: ubuntu-latest
    name: Initialize build
    outputs:
      changed_addons: ${{ steps.changed_addons.outputs.addons }}
      changed: ${{ steps.changed_addons.outputs.changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed_files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            portainer_ee_lts/**
            portainer_ee_sts/**
            dockge/**

      - name: Find changed add-ons
        id: changed_addons
        run: |
          declare -a changed_addons

          # Check if any addon files changed
          if [[ "${{ steps.changed_files.outputs.any_changed }}" == "true" ]]; then
            for addon in portainer_ee_lts portainer_ee_sts dockge; do
              if [[ "${{ steps.changed_files.outputs.all_changed_files }}" =~ $addon ]]; then
                changed_addons+=("\"${addon}\"");
              fi
            done
          else
            # If no changes detected (e.g., initial commit), build all addons
            echo "No changed files detected, building all addons"
            changed_addons=("\"portainer_ee_lts\"" "\"portainer_ee_sts\"" "\"dockge\"")
          fi

          changed=$(echo ${changed_addons[@]} | jq -sc '.')
          echo "addons=${changed}" >> "$GITHUB_OUTPUT"

          if [[ ${#changed_addons[@]} -gt 0 ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

  build:
    needs: init
    runs-on: ubuntu-latest
    if: needs.init.outputs.changed == 'true'
    name: Build ${{ matrix.addon }} add-on
    strategy:
      matrix:
        addon: ${{ fromJson(needs.init.outputs.changed_addons) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build ${{ matrix.addon }} add-on
        uses: home-assistant/builder@master
        with:
          args: |
            --test \
            --target /data/${{ matrix.addon }} \
            --docker-hub shobuprime \
            --image ${{ matrix.addon }} \
            --all
