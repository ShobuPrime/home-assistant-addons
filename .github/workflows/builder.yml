name: Builder

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  init:
    runs-on: ubuntu-latest
    name: Initialize build
    outputs:
      changed_addons: ${{ steps.changed_addons.outputs.addons }}
      changed: ${{ steps.changed_addons.outputs.changed }}
      all_addons: ${{ steps.all_addons.outputs.addons }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Discover all add-ons
        id: all_addons
        run: |
          # Dynamically find all addon directories (those with config.yaml)
          declare -a all_addons
          for config in */config.yaml; do
            addon_dir=$(dirname "$config")
            # Skip hidden directories and non-addon directories
            if [[ ! "$addon_dir" =~ ^\. ]]; then
              all_addons+=("$addon_dir")
              echo "Found addon: $addon_dir"
            fi
          done

          # Create JSON array of all addons
          addons_json=$(printf '%s\n' "${all_addons[@]}" | jq -R . | jq -sc '.')
          echo "addons=${addons_json}" >> "$GITHUB_OUTPUT"
          echo "All addons: ${addons_json}"

      - name: Get changed files
        id: changed_files
        uses: tj-actions/changed-files@v41

      - name: Find changed add-ons
        id: changed_addons
        run: |
          declare -a changed_addons

          # Get all addon directories dynamically
          declare -a all_addon_dirs
          for config in */config.yaml; do
            addon_dir=$(dirname "$config")
            if [[ ! "$addon_dir" =~ ^\. ]]; then
              all_addon_dirs+=("$addon_dir")
            fi
          done

          # Check if any addon files changed
          if [[ "${{ steps.changed_files.outputs.any_changed }}" == "true" ]]; then
            changed_files="${{ steps.changed_files.outputs.all_changed_files }}"

            for addon in "${all_addon_dirs[@]}"; do
              # Check if any file in this addon directory changed
              if echo "$changed_files" | grep -q "^${addon}/\|${addon}/"; then
                changed_addons+=("\"${addon}\"")
                echo "Addon changed: $addon"
              fi
            done
          fi

          # If no changes detected (e.g., initial commit or workflow changes), build all addons
          if [[ ${#changed_addons[@]} -eq 0 ]]; then
            echo "No addon-specific changes detected, building all addons"
            for addon in "${all_addon_dirs[@]}"; do
              changed_addons+=("\"${addon}\"")
            done
          fi

          changed=$(echo ${changed_addons[@]} | jq -sc '.')
          echo "addons=${changed}" >> "$GITHUB_OUTPUT"

          if [[ ${#changed_addons[@]} -gt 0 ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

          echo "Changed addons: ${changed}"

  build:
    needs: init
    runs-on: ubuntu-latest
    if: needs.init.outputs.changed == 'true'
    name: Build ${{ matrix.addon }} add-on
    strategy:
      matrix:
        addon: ${{ fromJson(needs.init.outputs.changed_addons) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build ${{ matrix.addon }} add-on
        uses: home-assistant/builder@master
        with:
          args: |
            --test \
            --target /data/${{ matrix.addon }} \
            --docker-hub shobuprime \
            --image ${{ matrix.addon }} \
            --amd64 \
            --aarch64
